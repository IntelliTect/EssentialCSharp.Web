name: Setup GitHub Copilot Agent Environment

# This workflow configures the environment for GitHub Copilot agents
# It reuses configuration from the main Build-Test-And-Deploy workflow
# to ensure consistency and reduce duplication

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    environment: "BuildAndUploadImage"

    steps:
      - uses: actions/checkout@v5

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
          source-url: https://pkgs.dev.azure.com/intelliTect/_packaging/EssentialCSharp/nuget/v3/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.AZURE_DEVOPS_PAT }}

      - name: Set up dependency caching for faster builds
        uses: actions/cache@v4
        id: nuget-cache
        with:
          path: |
            ~/.nuget/packages
            ${{ github.workspace }}/**/obj/project.assets.json
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
            ${{ runner.os }}-nuget-

      - name: Restore with dotnet
        run: dotnet restore

      - name: Build with dotnet
        run: dotnet build -p:ContinuousIntegrationBuild=True -p:ReleaseDateAttribute=True --configuration Release --no-restore

      - name: Run .NET Tests
        run: dotnet test --no-build --configuration Release

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Docker build
        uses: docker/build-push-action@v6
        with:
          push: false
          tags: copilot-env-validation
          file: ./EssentialCSharp.Web/Dockerfile
          context: .
          secrets: |
            "nuget_auth_token=${{ secrets.AZURE_DEVOPS_PAT }}"
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set up Node.js for frontend development
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install additional development tools
        run: |
          # Install common development tools that Copilot agents might need
          echo "Installing additional tools for Copilot agent environment..."
          
          # Install Azure CLI for cloud operations
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          
          # Install GitHub CLI for repository operations
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update && sudo apt install gh -y
          
          # Install EF Core tools globally
          dotnet tool install --global dotnet-ef

      - name: Validate development tools
        run: |
          echo "ğŸ” Validating installed tools..."
          echo "Azure CLI: $(az --version | head -1 || echo 'Not available')"
          echo "GitHub CLI: $(gh --version | head -1 || echo 'Not available')"
          echo "EF Core CLI: $(dotnet ef --version || echo 'Not available')"
          echo "Node.js: $(node --version || echo 'Not available')"
          echo "npm: $(npm --version || echo 'Not available')"



      - name: Test Copilot agent environment
        run: |
          echo "ğŸ§ª Testing Copilot agent environment capabilities..."
          
          # Test basic .NET commands
          dotnet --list-sdks
          dotnet --list-runtimes
          
          # Test EF Core tools
          dotnet ef --help > /dev/null && echo "âœ… EF Core tools working"
          
          # Test that we can create a simple project (cleanup afterwards)
          cd /tmp
          dotnet new console -n TestCopilotEnv
          cd TestCopilotEnv
          dotnet build
          cd ..
          rm -rf TestCopilotEnv
          echo "âœ… Project creation and build test passed"
          
          # Test Docker functionality
          docker --version
          echo "âœ… Docker available"
          
          # Test that our solution is properly restored and built
          cd ${{ github.workspace }}
          echo "âœ… Solution build completed successfully"

      - name: Display environment information
        run: |
          echo "âœ… Environment setup complete for GitHub Copilot agents"
          echo "ğŸ“¦ .NET Version: $(dotnet --version)"
          echo "ğŸ—ï¸ Build Status: Success"
          echo "ğŸ³ Docker Status: Ready"
          echo "ğŸ“‚ Repository: ${{ github.repository }}"
          echo "ğŸ”§ This environment is configured for:"
          echo "   - .NET 9.0 development with C# 13"
          echo "   - ASP.NET Core web applications"
          echo "   - Entity Framework with SQL Server"
          echo "   - Semantic Kernel AI integration"
          echo "   - Azure OpenAI and vector databases"
          echo "   - Docker containerization"
          echo "   - Azure CLI and GitHub CLI tools"
          echo "   - NuGet package management (public and private feeds)"
          echo "   - Node.js for frontend tooling"