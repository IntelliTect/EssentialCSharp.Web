name: Setup GitHub Copilot Agent Environment

# This workflow configures the environment for GitHub Copilot agents
# It reuses configuration from the main Build-Test-And-Deploy workflow
# to ensure consistency and reduce duplication

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    environment: "BuildAndUploadImage"

    steps:
      - uses: actions/checkout@v5

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
          source-url: https://pkgs.dev.azure.com/intelliTect/_packaging/EssentialCSharp/nuget/v3/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.AZURE_DEVOPS_PAT }}

      - name: Set up dependency caching for faster builds
        uses: actions/cache@v4
        id: nuget-cache
        with:
          path: |
            ~/.nuget/packages
            ${{ github.workspace }}/**/obj/project.assets.json
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
            ${{ runner.os }}-nuget-

      - name: Restore with dotnet
        run: dotnet restore

      - name: Build with dotnet
        run: dotnet build -p:ContinuousIntegrationBuild=True -p:ReleaseDateAttribute=True --configuration Release --no-restore

      - name: Run .NET Tests
        run: dotnet test --no-build --configuration Release

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Docker build
        uses: docker/build-push-action@v6
        with:
          push: false
          tags: copilot-env-validation
          file: ./EssentialCSharp.Web/Dockerfile
          context: .
          secrets: |
            "nuget_auth_token=${{ secrets.AZURE_DEVOPS_PAT }}"
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Display environment information
        run: |
          echo "‚úÖ Environment setup complete for GitHub Copilot agents"
          echo "üì¶ .NET Version: $(dotnet --version)"
          echo "üèóÔ∏è Build Status: Success"
          echo "üê≥ Docker Status: Ready"
          echo "üìÇ Repository: ${{ github.repository }}"
          echo "üîß This environment is configured for:"
          echo "   - .NET 9.0 development"
          echo "   - ASP.NET Core web applications"
          echo "   - Entity Framework"
          echo "   - Semantic Kernel AI integration"
          echo "   - Docker containerization"
          echo "   - NuGet package management (public and private feeds)"